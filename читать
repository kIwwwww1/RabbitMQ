–û—Ç–ª–∏—á–Ω–æ! üëè
–¢—ã —É–∂–µ –≤—ã—É—á–∏–ª **–æ—Å–Ω–æ–≤—É RabbitMQ**, –≤–∫–ª—é—á–∞—è —Ä–∞–±–æ—Ç—É —Å **–æ—á–µ—Ä–µ–¥—è–º–∏**, **producer/consumer**, –∏ **exchange‚Äô–∞–º–∏**.
–î–∞–≤–∞–π —è –ø–æ–º–æ–≥—É —Ç–µ–±–µ:
1Ô∏è‚É£ –ø–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω—é, **—á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–≤–æ–π –∫–æ–¥**,
2Ô∏è‚É£ —Ä–∞—Å—Å–∫–∞–∂—É **—á—Ç–æ –µ—â—ë –Ω—É–∂–Ω–æ –≤—ã—É—á–∏—Ç—å**, —á—Ç–æ–±—ã —É–≤–µ—Ä–µ–Ω–Ω–æ –≤–ª–∞–¥–µ—Ç—å RabbitMQ.

---

## üß© –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–≤–æ–π –∫–æ–¥

### 1. Producer (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π)

```python
import pika

connection = pika.BlockingConnection(
    pika.ConnectionParameters(host='localhost'))
channel = connection.channel()

channel.queue_declare(queue='hello')

channel.basic_publish(exchange='', routing_key='hello', body='Hello World!')
print('–°–æ–æ–±—â–µ–Ω–∏–µ "Hello World" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ')
channel.close()
```

#### –ü–æ—à–∞–≥–æ–≤–æ:

1. **–ü–æ–¥–∫–ª—é—á–∞–µ—à—å—Å—è –∫ RabbitMQ:**

   ```python
   pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
   ```

   ‚Äî —Å–æ–∑–¥–∞—ë—Ç TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å RabbitMQ –Ω–∞ —Ç–≤–æ–µ–π –º–∞—à–∏–Ω–µ (localhost).

2. **–°–æ–∑–¥–∞—ë—à—å –∫–∞–Ω–∞–ª (channel):**
   ‚Äî –≠—Ç–æ –∫–∞–∫ "–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ" –≤–Ω—É—Ç—Ä–∏ TCP-—Å–µ—Å—Å–∏–∏.
   –ß–µ—Ä–µ–∑ –Ω–µ–≥–æ –∏–¥—É—Ç –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã: –ø—É–±–ª–∏–∫–∞—Ü–∏—è, –ø–æ–ª—É—á–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π –∏ —Ç. –¥.

3. **–û–±—ä—è–≤–ª—è–µ—à—å –æ—á–µ—Ä–µ–¥—å:**

   ```python
   channel.queue_declare(queue='hello')
   ```

   ‚Äî –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥–∏ `hello` –µ—â—ë –Ω–µ—Ç, RabbitMQ –µ—ë —Å–æ–∑–¥–∞—ë—Ç.
   –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ, –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –æ—á–µ—Ä–µ–¥—å.

4. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ:**

   ```python
   channel.basic_publish(exchange='', routing_key='hello', body='Hello World!')
   ```

   ‚Äî `exchange=''` (–ø—É—Å—Ç–æ–π –æ–±–º–µ–Ω–Ω–∏–∫) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–π–¥—ë—Ç **–ø—Ä—è–º–æ –≤ –æ—á–µ—Ä–µ–¥—å**, –∏–º—è –∫–æ—Ç–æ—Ä–æ–π —É–∫–∞–∑–∞–Ω–æ –≤ `routing_key`.

5. **–ó–∞–∫—Ä—ã–≤–∞–µ—à—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:**
   ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –∫–∞–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç.

---

### 2. Consumer (–ø–æ–ª—É—á–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π)

```python
import pika

connection = pika.BlockingConnection(
    pika.ConnectionParameters(host='localhost'))
channel = connection.channel()

channel.queue_declare(queue='hello')

def main(ch, method, properties, body):
    print(f'–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ {body.decode()}')

channel.basic_consume(queue='hello',
                      on_message_callback=main,
                      auto_ack=True)

print('–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π')
channel.start_consuming()
```

#### –ü–æ—à–∞–≥–æ–≤–æ:

1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ RabbitMQ.
2. –°–æ–∑–¥–∞—ë—Ç –∫–∞–Ω–∞–ª.
3. –û–±—ä—è–≤–ª—è–µ—Ç –æ—á–µ—Ä–µ–¥—å (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ producer –µ—â—ë –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è).
4. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç **callback-—Ñ—É–Ω–∫—Ü–∏—é** `main`, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
5. –ó–∞–ø—É—Å–∫–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª `start_consuming()` ‚Äî consumer ‚Äú—Å–ª—É—à–∞–µ—Ç‚Äù –æ—á–µ—Ä–µ–¥—å –∏ –≤—ã–∑—ã–≤–∞–µ—Ç callback –ø—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

üü¢ –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:

* Producer –ø–∏—à–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å `hello`
* Consumer —á–∏—Ç–∞–µ—Ç –∏–∑ –æ—á–µ—Ä–µ–¥–∏ `hello`

---

## üìò –ß—Ç–æ —Ç–µ–±–µ –µ—â—ë —Å—Ç–æ–∏—Ç –≤—ã—É—á–∏—Ç—å, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –±–∞–∑—É RabbitMQ

–¢—ã —É–∂–µ –∑–Ω–∞–µ—à—å 70% –Ω—É–∂–Ω–æ–≥–æ!
–û—Å—Ç–∞–ª–∏—Å—å –≤–∞–∂–Ω—ã–µ, –Ω–æ –Ω–µ—Å–ª–æ–∂–Ω—ã–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–¥—É—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É üëá

### 1. Durable (—É—Å—Ç–æ–π—á–∏–≤—ã–µ) –æ—á–µ—Ä–µ–¥–∏ –∏ persistent (—É—Å—Ç–æ–π—á–∏–≤—ã–µ) —Å–æ–æ–±—â–µ–Ω–∏—è

–ï—Å–ª–∏ RabbitMQ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è **–ø—Ä–æ–ø–∞–¥—É—Ç**, –µ—Å–ª–∏ —Ç—ã –Ω–µ —Å–¥–µ–ª–∞–ª –∏—Ö —É—Å—Ç–æ–π—á–∏–≤—ã–º–∏.

‚úÖ –ù—É–∂–Ω–æ:

```python
channel.queue_declare(queue='hello', durable=True)
channel.basic_publish(
    exchange='',
    routing_key='hello',
    body='Hello World!',
    properties=pika.BasicProperties(delivery_mode=2)  # –¥–µ–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ persistent
)
```

---

### 2. Ack / Nack / Requeue

–ö–æ–≥–¥–∞ consumer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–Ω –¥–æ–ª–∂–µ–Ω **–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å**, —á—Ç–æ –≤—Å—ë –æ–∫:

```python
channel.basic_consume(queue='hello', on_message_callback=callback, auto_ack=False)
```

–í–Ω—É—Ç—Ä–∏ callback:

```python
def callback(ch, method, properties, body):
    try:
        print(body.decode())
        ch.basic_ack(delivery_tag=method.delivery_tag)
    except Exception:
        ch.basic_nack(delivery_tag=method.delivery_tag, requeue=True)
```

* `basic_ack` ‚Üí –≤—Å—ë –æ–∫, —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
* `basic_nack` ‚Üí –æ—à–∏–±–∫–∞, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ (`requeue=True`)

---

### 3. Prefetch (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è)

–ï—Å–ª–∏ –æ–¥–∏–Ω consumer —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ, RabbitMQ –º–æ–∂–µ—Ç ‚Äú–ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å‚Äù –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
–ß—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å:

```python
channel.basic_qos(prefetch_count=1)
```

‚û°Ô∏è RabbitMQ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å consumer-—É —Ç–æ–ª—å–∫–æ **–æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑** ‚Äî —Å–ª–µ–¥—É—é—â–µ–µ –ø—Ä–∏–¥—ë—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `ack`.

---

### 4. Exchange types (direct, fanout, topic, headers)

–¢—ã —É–∂–µ –∑–Ω–∞–µ—à—å —Ç–µ–æ—Ä–∏—é ‚Äî —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è:

* `direct` ‚Äî –∫–ª—é—á —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (`routing_key='error'`)
* `fanout` ‚Äî —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (–≤—Å–µ–º –æ—á–µ—Ä–µ–¥—è–º)
* `topic` ‚Äî —à–∞–±–ª–æ–Ω—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ (`routing_key='user.*'`)
* `headers` ‚Äî –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º

---

### 5. Dead Letter Queue (DLQ)

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ (–æ—à–∏–±–∫–∞, –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –∏ —Ç. –¥.), –µ–≥–æ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ **"–º—ë—Ä—Ç–≤—É—é –æ—á–µ—Ä–µ–¥—å"**, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ.

---

### 6. Monitoring

–ü–æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å **RabbitMQ Management Plugin**:

```bash
rabbitmq-plugins enable rabbitmq_management
```

–ü–∞–Ω–µ–ª—å –±—É–¥–µ—Ç –Ω–∞:
üëâ [http://localhost:15672](http://localhost:15672)
(–ª–æ–≥–∏–Ω: guest, –ø–∞—Ä–æ–ª—å: guest)

–¢–∞–º –≤–∏–¥–Ω–æ –æ—á–µ—Ä–µ–¥–∏, –æ–±–º–µ–Ω–Ω–∏–∫–∏, –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π, —Å–∫–æ—Ä–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.

---

## üöÄ –†–µ–∑—é–º–µ ‚Äî —á—Ç–æ –Ω—É–∂–Ω–æ –≤—ã—É—á–∏—Ç—å –¥–ª—è ‚Äú—É–≤–µ—Ä–µ–Ω–Ω–æ–π –±–∞–∑—ã‚Äù

| –¢–µ–º–∞                                            | –ß—Ç–æ –∏–∑—É—á–∏—Ç—å                    |
| ----------------------------------------------- | ------------------------------ |
| ‚úÖ Producer / Consumer                           | —Ç—ã —É–∂–µ –∑–Ω–∞–µ—à—å                  |
| ‚úÖ Queue / Exchange / Binding                    | —Ç—ã —É–∂–µ –∑–Ω–∞–µ—à—å                  |
| üß± Durable queue / Persistent messages          | –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ                    |
| üß† Ack / Nack / Prefetch                        | —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è–º–∏     |
| üì¶ Exchange types (direct/fanout/topic/headers) | –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö    |
| ‚ö∞Ô∏è Dead Letter Queue                            | –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫               |
| üìä Monitoring (RabbitMQ Management)             | –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ              |
| üß© Routing keys –∏ —à–∞–±–ª–æ–Ω—ã                       | –≥–∏–±–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π |

---

–•–æ—á–µ—à—å, —è —Å–¥–µ–ª–∞—é –¥–ª—è —Ç–µ–±—è **–∫—Ä–∞—Ç–∫–∏–π —É—á–µ–±–Ω—ã–π –ø–ª–∞–Ω** —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ (—Ç–∏–ø–∞ ‚Äú–∏–∑—É—á–∏ —ç—Ç–æ, —Å–¥–µ–ª–∞–π —Ç–∞–∫–æ–π –∫–æ–¥, –ø—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Äù) ‚Äî —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ RabbitMQ —Å –Ω—É–ª—è –¥–æ —É–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –∑–∞ 1‚Äì2 –¥–Ω—è?

================================================================================================================================================
================================================================================================================================================
================================================================================================================================================
================================================================================================================================================
================================================================================================================================================
================================================================================================================================================
================================================================================================================================================
================================================================================================================================================

–û—Ç–ª–∏—á–Ω–æ üí™ ‚Äî —Ç—ã –ø–æ–¥–æ—à—ë–ª –∫ **—Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–≤–Ω—é**: –ø–µ—Ä–µ—Ö–æ–¥—É —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ **pika** –Ω–∞ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π aio-pika**.

üëâ –≠—Ç–æ –≤–∞–∂–Ω–æ, –µ—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å –ø–∏—Å–∞—Ç—å **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ Python-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å `asyncio`, `FastAPI`, `aiohttp` –∏ —Ç.–¥.), –≥–¥–µ –Ω–µ–ª—å–∑—è –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫ `BlockingConnection`.

---

## üöÄ –í —á—ë–º —Å—É—Ç—å —Ä–∞–∑–ª–∏—á–∏–π

| –ß—Ç–æ           | pika (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)                                  | aio-pika (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)              |
| ------------- | -------------------------------------------------- | ----------------------------------- |
| –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ   | `BlockingConnection()`                             | `await aio_pika.connect_robust()`   |
| –ö–∞–Ω–∞–ª         | `connection.channel()`                             | `await connection.channel()`        |
| –ü—É–±–ª–∏–∫–∞—Ü–∏—è    | `channel.basic_publish(...)`                       | `await exchange.publish(...)`       |
| –ü–æ–ª—É—á–µ–Ω–∏–µ     | `channel.basic_consume(...)` –∏ `start_consuming()` | —á–µ—Ä–µ–∑ `async for message in queue:` |
| Callback      | –æ–±—ã—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è                                    | `async def callback(...)`           |
| –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ | `auto_ack=True` –∏–ª–∏ `ch.basic_ack()`               | `await message.ack()`               |

---

## üß© –ü—Ä–∏–º–µ—Ä 1: Producer (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)

### üß± –ë—ã–ª–æ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, pika)

```python
import pika

connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()
channel.queue_declare(queue='hello')

channel.basic_publish(exchange='', routing_key='hello', body='Hello World!')
print('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ')
connection.close()
```

---

### ‚öôÔ∏è –°—Ç–∞–ª–æ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, aio-pika)

```python
import asyncio
import aio_pika

async def main():
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ RabbitMQ
    connection = await aio_pika.connect_robust("amqp://guest:guest@localhost/")
    async with connection:
        # –°–æ–∑–¥–∞—ë–º –∫–∞–Ω–∞–ª
        channel = await connection.channel()

        # –û–±—ä—è–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å
        queue = await channel.declare_queue("hello", durable=True)

        # –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await channel.default_exchange.publish(
            aio_pika.Message(body=b"Hello World!"),
            routing_key=queue.name,
        )

        print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")

asyncio.run(main())
```

üîπ `connect_robust` ‚Äî –Ω–∞–¥—ë–∂–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è).
üîπ `aio_pika.Message` ‚Äî –æ–±—ä–µ–∫—Ç, –≥–¥–µ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ (`delivery_mode=2`, –∑–∞–≥–æ–ª–æ–≤–∫–∏, TTL –∏ —Ç.–ø.).
üîπ –í—Å—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `await`, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

---

## üß© –ü—Ä–∏–º–µ—Ä 2: Consumer (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)

### üß± –ë—ã–ª–æ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, pika)

```python
import pika

def callback(ch, method, properties, body):
    print(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {body.decode()}")

connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()
channel.queue_declare(queue='hello')

channel.basic_consume(queue='hello', on_message_callback=callback, auto_ack=True)
print('–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π')
channel.start_consuming()
```

---

### ‚öôÔ∏è –°—Ç–∞–ª–æ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, aio-pika)

```python
import asyncio
import aio_pika

async def main():
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    connection = await aio_pika.connect_robust("amqp://guest:guest@localhost/")
    async with connection:
        # –ö–∞–Ω–∞–ª
        channel = await connection.channel()
        await channel.set_qos(prefetch_count=1)

        # –û—á–µ—Ä–µ–¥—å
        queue = await channel.declare_queue("hello", durable=True)

        print("üïí –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...")

        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        async with queue.iterator() as queue_iter:
            async for message in queue_iter:
                async with message.process():
                    print(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message.body.decode()}")

asyncio.run(main())
```

üß† –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:

* `async with queue.iterator()` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º.
* `async with message.process():` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç `message.ack()` –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –±–ª–æ–∫–∞.
* –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å `await asyncio.sleep()` –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ ‚Äî –≤—Å—ë –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ.

---

## üß† –ß—Ç–æ –ø–æ–º–µ–Ω—è–ª–æ—Å—å –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ

| –ö–æ–Ω—Ü–µ–ø—Ü–∏—è          | –í pika                                    | –í aio-pika                                             |
| ------------------ | ----------------------------------------- | ------------------------------------------------------ |
| API —Å—Ç–∏–ª—å          | –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π (–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫)              | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π (`asyncio`, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)                  |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞        | –æ–¥–∏–Ω –ø–æ—Ç–æ–∫, `start_consuming()` –±–ª–æ–∫–∏—Ä—É–µ—Ç | –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ —Ñ–æ–Ω–µ, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞          | callback-—Ñ—É–Ω–∫—Ü–∏–∏                          | –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã –∏–ª–∏ `async` callback             |
| –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ        | `BlockingConnection`                      | `connect_robust`                                       |
| –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å | –≤—Ä—É—á–Ω—É—é                                   | –≤—Å—Ç—Ä–æ–µ–Ω–æ (–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤)     |

---

## üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (FastAPI)

```python
# worker.py
import asyncio
import aio_pika

async def consume():
    connection = await aio_pika.connect_robust("amqp://guest:guest@localhost/")
    channel = await connection.channel()
    queue = await channel.declare_queue("tasks", durable=True)

    async with queue.iterator() as iterator:
        async for message in iterator:
            async with message.process():
                print("üß† –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–¥–∞—á—É:", message.body.decode())

if __name__ == "__main__":
    asyncio.run(consume())
```

---

## ‚úÖ –ú–∏–Ω–∏-—à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ aio-pika

| –ó–∞–¥–∞—á–∞           | –ö–æ–¥                                                                                 |
| ---------------- | ----------------------------------------------------------------------------------- |
| –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è     | `connection = await aio_pika.connect_robust("amqp://user:pass@host/")`              |
| –ö–∞–Ω–∞–ª            | `channel = await connection.channel()`                                              |
| –û–±—ä—è–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å | `queue = await channel.declare_queue("name", durable=True)`                         |
| –ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å      | `await channel.default_exchange.publish(Message(body=b"data"), routing_key="name")` |
| –ü—Ä–æ—á–∏—Ç–∞—Ç—å        | `async for message in queue.iterator(): ...`                                        |
| –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å      | `await message.ack()`                                                               |
| –û—Ç–º–µ–Ω–∏—Ç—å         | `await message.nack(requeue=True)`                                                  |
| Prefetch         | `await channel.set_qos(prefetch_count=1)`                                           |

---

–•–æ—á–µ—à—å, —è –ø–æ–∫–∞–∂—É —Ç–µ–±–µ **–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç** (producer + consumer –Ω–∞ aio-pika, —Å –æ—á–µ—Ä–µ–¥—å—é `tasks` –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä ‚Äú–æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∏—Å–ª–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞‚Äù)?
–û–Ω –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥—ë—Ç, —á—Ç–æ–±—ã –∑–∞–∫—Ä–µ–ø–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ —Å `pika` –Ω–∞ `aio-pika`.
