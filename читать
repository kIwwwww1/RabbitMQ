## üß© –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–≤–æ–π –∫–æ–¥

### 1. Producer (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π)

import pika

connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
channel = connection.channel()

channel.queue_declare(queue='hello')

channel.basic_publish(exchange='', routing_key='hello', body='Hello World!')
print('–°–æ–æ–±—â–µ–Ω–∏–µ "Hello World" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ')
channel.close()

#### –ü–æ—à–∞–≥–æ–≤–æ:

1. **–ü–æ–¥–∫–ª—é—á–∞–µ—à—å—Å—è –∫ RabbitMQ:**

pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
   ‚Äî —Å–æ–∑–¥–∞—ë—Ç TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å RabbitMQ –Ω–∞ —Ç–≤–æ–µ–π –º–∞—à–∏–Ω–µ (localhost)

2. **–°–æ–∑–¥–∞—ë—à—å –∫–∞–Ω–∞–ª (channel):**
   ‚Äî –≠—Ç–æ –∫–∞–∫ "–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ" –≤–Ω—É—Ç—Ä–∏ TCP-—Å–µ—Å—Å–∏–∏.
   –ß–µ—Ä–µ–∑ –Ω–µ–≥–æ –∏–¥—É—Ç –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã: –ø—É–±–ª–∏–∫–∞—Ü–∏—è, –ø–æ–ª—É—á–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π –∏ —Ç. –¥.

3. **–û–±—ä—è–≤–ª—è–µ—à—å –æ—á–µ—Ä–µ–¥—å:**

channel.queue_declare(queue='hello')

   ‚Äî –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥–∏ `hello` –µ—â—ë –Ω–µ—Ç, RabbitMQ –µ—ë —Å–æ–∑–¥–∞—ë—Ç.
   –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ, –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –æ—á–µ—Ä–µ–¥—å.

4. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ:**

channel.basic_publish(exchange='', routing_key='hello', body='Hello World!')

   `exchange=''` (–ø—É—Å—Ç–æ–π –æ–±–º–µ–Ω–Ω–∏–∫) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–π–¥—ë—Ç **–ø—Ä—è–º–æ –≤ –æ—á–µ—Ä–µ–¥—å**, –∏–º—è –∫–æ—Ç–æ—Ä–æ–π —É–∫–∞–∑–∞–Ω–æ –≤ `routing_key`

5. **–ó–∞–∫—Ä—ã–≤–∞–µ—à—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:**
   ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –∫–∞–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç.


### 2. Consumer (–ø–æ–ª—É—á–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π)

import pika

connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
channel = connection.channel()

channel.queue_declare(queue='hello')

def main(ch, method, properties, body):
    print(f'–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ {body.decode()}')

channel.basic_consume(queue='hello', on_message_callback=main, auto_ack=True)

print('–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π')
channel.start_consuming()

#### –ü–æ—à–∞–≥–æ–≤–æ:

1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ RabbitMQ.
2. –°–æ–∑–¥–∞—ë—Ç –∫–∞–Ω–∞–ª.
3. –û–±—ä—è–≤–ª—è–µ—Ç –æ—á–µ—Ä–µ–¥—å (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ producer –µ—â—ë –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è).
4. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç **callback-—Ñ—É–Ω–∫—Ü–∏—é** `main`, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
5. –ó–∞–ø—É—Å–∫–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª `start_consuming()` ‚Äî consumer ‚Äú—Å–ª—É—à–∞–µ—Ç‚Äù –æ—á–µ—Ä–µ–¥—å –∏ –≤—ã–∑—ã–≤–∞–µ—Ç callback –ø—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

üü¢ –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:

* Producer –ø–∏—à–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å `hello`
* Consumer —á–∏—Ç–∞–µ—Ç –∏–∑ –æ—á–µ—Ä–µ–¥–∏ `hello`


–¢—ã —É–∂–µ –∑–Ω–∞–µ—à—å 70% –Ω—É–∂–Ω–æ–≥–æ!
–û—Å—Ç–∞–ª–∏—Å—å –≤–∞–∂–Ω—ã–µ, –Ω–æ –Ω–µ—Å–ª–æ–∂–Ω—ã–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–¥—É—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É üëá

### 1. Durable (—É—Å—Ç–æ–π—á–∏–≤—ã–µ) –æ—á–µ—Ä–µ–¥–∏ –∏ persistent (—É—Å—Ç–æ–π—á–∏–≤—ã–µ) —Å–æ–æ–±—â–µ–Ω–∏—è

–ï—Å–ª–∏ RabbitMQ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è **–ø—Ä–æ–ø–∞–¥—É—Ç**, –µ—Å–ª–∏ —Ç—ã –Ω–µ —Å–¥–µ–ª–∞–ª –∏—Ö —É—Å—Ç–æ–π—á–∏–≤—ã–º–∏.

‚úÖ –ù—É–∂–Ω–æ:

channel.queue_declare(queue='hello', durable=True)
channel.basic_publish(
    exchange='',
    routing_key='hello',
    body='Hello World!',
    properties=pika.BasicProperties(delivery_mode=2)  # –¥–µ–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ persistent
)


### 2. Ack / Nack / Requeue

–ö–æ–≥–¥–∞ consumer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–Ω –¥–æ–ª–∂–µ–Ω **–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å**, —á—Ç–æ –≤—Å—ë –æ–∫:

channel.basic_consume(queue='hello', on_message_callback=callback, auto_ack=False)

–í–Ω—É—Ç—Ä–∏ callback:

def callback(ch, method, properties, body):
    try:
        print(body.decode())
        ch.basic_ack(delivery_tag=method.delivery_tag)
    except Exception:
        ch.basic_nack(delivery_tag=method.delivery_tag, requeue=True)

* `basic_ack` ‚Üí –≤—Å—ë –æ–∫, —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
* `basic_nack` ‚Üí –æ—à–∏–±–∫–∞, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ (`requeue=True`)

---

### 3. Prefetch (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è)

–ï—Å–ª–∏ –æ–¥–∏–Ω consumer —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ, RabbitMQ –º–æ–∂–µ—Ç ‚Äú–ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å‚Äù –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
–ß—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å:

channel.basic_qos(prefetch_count=1)

‚û°Ô∏è RabbitMQ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å consumer-—É —Ç–æ–ª—å–∫–æ **–æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑** ‚Äî —Å–ª–µ–¥—É—é—â–µ–µ –ø—Ä–∏–¥—ë—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `ack`.


### 4. Exchange types (direct, fanout, topic, headers)

–¢—ã —É–∂–µ –∑–Ω–∞–µ—à—å —Ç–µ–æ—Ä–∏—é ‚Äî —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è:

* `direct` ‚Äî –∫–ª—é—á —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (`routing_key='error'`)
* `fanout` ‚Äî —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (–≤—Å–µ–º –æ—á–µ—Ä–µ–¥—è–º)
* `topic` ‚Äî —à–∞–±–ª–æ–Ω—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ (`routing_key='user.*'`)
* `headers` ‚Äî –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º


### 5. Dead Letter Queue (DLQ)

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ (–æ—à–∏–±–∫–∞, –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –∏ —Ç. –¥.), –µ–≥–æ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ **"–º—ë—Ä—Ç–≤—É—é –æ—á–µ—Ä–µ–¥—å"**, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ.


### 6. Monitoring

–ü–æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å **RabbitMQ Management Plugin**:

rabbitmq-plugins enable rabbitmq_management

–ü–∞–Ω–µ–ª—å –±—É–¥–µ—Ç –Ω–∞:
üëâ [http://localhost:15672](http://localhost:15672)
(–ª–æ–≥–∏–Ω: guest, –ø–∞—Ä–æ–ª—å: guest)

–¢–∞–º –≤–∏–¥–Ω–æ –æ—á–µ—Ä–µ–¥–∏, –æ–±–º–µ–Ω–Ω–∏–∫–∏, –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π, —Å–∫–æ—Ä–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.

| –¢–µ–º–∞                                             | –ß—Ç–æ –∏–∑—É—á–∏—Ç—å                    |
| -----------------------------------------------  | ------------------------------ |
| ‚úÖ Producer / Consumer                           | —Ç—ã —É–∂–µ –∑–Ω–∞–µ—à—å                  |
| ‚úÖ Queue / Exchange / Binding                    | —Ç—ã —É–∂–µ –∑–Ω–∞–µ—à—å                  |
| üß± Durable queue / Persistent messages           | –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ                    |
| üß† Ack / Nack / Prefetch                         | —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è–º–∏     |
| üì¶ Exchange types (direct/fanout/topic/headers)  | –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö    |
| ‚ö∞Ô∏è Dead Letter Queue                             | –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫               |
| üìä Monitoring (RabbitMQ Management)              | –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ              |
| üß© Routing keys –∏ —à–∞–±–ª–æ–Ω—ã                        | –≥–∏–±–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π |

=====================================================================================================================

| –ß—Ç–æ           | pika (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)                                  | aio-pika (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)              |
| ------------- | -------------------------------------------------- | ----------------------------------- |
| –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ   | `BlockingConnection()`                             | `await aio_pika.connect_robust()`   |
| –ö–∞–Ω–∞–ª         | `connection.channel()`                             | `await connection.channel()`        |
| –ü—É–±–ª–∏–∫–∞—Ü–∏—è    | `channel.basic_publish(...)`                       | `await exchange.publish(...)`       |
| –ü–æ–ª—É—á–µ–Ω–∏–µ     | `channel.basic_consume(...)` –∏ `start_consuming()` | —á–µ—Ä–µ–∑ `async for message in queue:` |
| Callback      | –æ–±—ã—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è                                    | `async def callback(...)`           |
| –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ | `auto_ack=True` –∏–ª–∏ `ch.basic_ack()`               | `await message.ack()`               |

---

## üß© –ü—Ä–∏–º–µ—Ä 1: Producer (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)

### üß± –ë—ã–ª–æ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, pika)

import pika

connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()
channel.queue_declare(queue='hello')

channel.basic_publish(exchange='', routing_key='hello', body='Hello World!')
print('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ')
connection.close()

### ‚öôÔ∏è –°—Ç–∞–ª–æ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, aio-pika)

import asyncio
import aio_pika

async def main():
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ RabbitMQ
    connection = await aio_pika.connect_robust("amqp://guest:guest@localhost/")
    async with connection:
        # –°–æ–∑–¥–∞—ë–º –∫–∞–Ω–∞–ª
        channel = await connection.channel()

        # –û–±—ä—è–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å
        queue = await channel.declare_queue("hello", durable=True)

        # –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await channel.default_exchange.publish(
            aio_pika.Message(body=b"Hello World!"),
            routing_key=queue.name,
        )

        print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")

asyncio.run(main())

üîπ `connect_robust` ‚Äî –Ω–∞–¥—ë–∂–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è).
üîπ `aio_pika.Message` ‚Äî –æ–±—ä–µ–∫—Ç, –≥–¥–µ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ (`delivery_mode=2`, –∑–∞–≥–æ–ª–æ–≤–∫–∏, TTL –∏ —Ç.–ø.).
üîπ –í—Å—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `await`, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

## üß© –ü—Ä–∏–º–µ—Ä 2: Consumer (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)

### üß± –ë—ã–ª–æ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, pika)

import pika

def callback(ch, method, properties, body):
    print(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {body.decode()}")

connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()
channel.queue_declare(queue='hello')

channel.basic_consume(queue='hello', on_message_callback=callback, auto_ack=True)
print('–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π')
channel.start_consuming()


### ‚öôÔ∏è –°—Ç–∞–ª–æ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, aio-pika)

import asyncio
import aio_pika

async def main():
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    connection = await aio_pika.connect_robust("amqp://guest:guest@localhost/")
    async with connection:
        # –ö–∞–Ω–∞–ª
        channel = await connection.channel()
        await channel.set_qos(prefetch_count=1)

        # –û—á–µ—Ä–µ–¥—å
        queue = await channel.declare_queue("hello", durable=True)

        print("üïí –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...")

        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        async with queue.iterator() as queue_iter:
            async for message in queue_iter:
                async with message.process():
                    print(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message.body.decode()}")

asyncio.run(main())

üß† –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:

* `async with queue.iterator()` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º.
* `async with message.process():` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç `message.ack()` –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –±–ª–æ–∫–∞.
* –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å `await asyncio.sleep()` –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ ‚Äî –≤—Å—ë –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ.

---

## üß† –ß—Ç–æ –ø–æ–º–µ–Ω—è–ª–æ—Å—å –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ

| –ö–æ–Ω—Ü–µ–ø—Ü–∏—è          | –í pika                                    | –í aio-pika                                             |
| ------------------ | ----------------------------------------- | ------------------------------------------------------ |
| API —Å—Ç–∏–ª—å          | –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π (–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫)              | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π (`asyncio`, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)                  |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞        | –æ–¥–∏–Ω –ø–æ—Ç–æ–∫, `start_consuming()` –±–ª–æ–∫–∏—Ä—É–µ—Ç | –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ —Ñ–æ–Ω–µ, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞          | callback-—Ñ—É–Ω–∫—Ü–∏–∏                          | –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã –∏–ª–∏ `async` callback             |
| –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ        | `BlockingConnection`                      | `connect_robust`                                       |
| –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å | –≤—Ä—É—á–Ω—É—é                                   | –≤—Å—Ç—Ä–æ–µ–Ω–æ (–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤)     |

---

## üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (FastAPI)

# worker.py
import asyncio
import aio_pika

async def consume():
    connection = await aio_pika.connect_robust("amqp://guest:guest@localhost/")
    channel = await connection.channel()
    queue = await channel.declare_queue("tasks", durable=True)

    async with queue.iterator() as iterator:
        async for message in iterator:
            async with message.process():
                print("üß† –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–¥–∞—á—É:", message.body.decode())

if __name__ == "__main__":
    asyncio.run(consume())
```

---

## ‚úÖ –ú–∏–Ω–∏-—à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ aio-pika

| –ó–∞–¥–∞—á–∞           | –ö–æ–¥                                                                                 |
| ---------------- | ----------------------------------------------------------------------------------- |
| –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è     | `connection = await aio_pika.connect_robust("amqp://user:pass@host/")`              |
| –ö–∞–Ω–∞–ª            | `channel = await connection.channel()`                                              |
| –û–±—ä—è–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å | `queue = await channel.declare_queue("name", durable=True)`                         |
| –ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å      | `await channel.default_exchange.publish(Message(body=b"data"), routing_key="name")` |
| –ü—Ä–æ—á–∏—Ç–∞—Ç—å        | `async for message in queue.iterator(): ...`                                        |
| –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å      | `await message.ack()`                                                               |
| –û—Ç–º–µ–Ω–∏—Ç—å         | `await message.nack(requeue=True)`                                                  |
| Prefetch         | `await channel.set_qos(prefetch_count=1)`                                           |


==========================================================================================================


–û—Ç–ª–∏—á–Ω–æ ‚Äî –Ω–∏–∂–µ ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ–µ, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —á–µ—Ç—ã—Ä—ë—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±–º–µ–Ω–Ω–∏–∫–æ–≤ (exchanges) –≤ RabbitMQ: **direct**, **fanout**, **topic**, **headers** ‚Äî –∫–∞–∫ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –∫–æ–≥–¥–∞ –∫–∞–∫–æ–π –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–º –∫–æ—Ä–æ—Ç–∫—É—é —Ç–µ–æ—Ä–∏—é, —Ç–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã –Ω–∞ **Python** —Å `pika` (BlockingConnection), –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å/–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å.

# –í–≤–µ–¥–µ–Ω–∏–µ (–æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ)

–í RabbitMQ producer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ **exchange**; exchange —Ä–µ—à–∞–µ—Ç, –≤ –∫–∞–∫–∏–µ –æ—á–µ—Ä–µ–¥–∏ (queues) –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Ç–∏–ø–µ exchange –∏ –ø—Ä–∞–≤–∏–ª–∞—Ö –ø—Ä–∏–≤—è–∑–∫–∏ (bindings). –û—á–µ—Ä–µ–¥–∏ –∑–∞—Ç–µ–º –ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ (consumers) —á–∏—Ç–∞—é—Ç –∏—Ö. –û—Å–Ω–æ–≤–Ω—ã–µ exchange-—Ç–∏–ø—ã: `direct`, `fanout`, `topic`, `headers`.

---

# 1) direct

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

`direct` ‚Äî —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π: –æ–±–º–µ–Ω–Ω–∏–∫ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ –æ—á–µ—Ä–µ–¥–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö **binding key** —Ç–æ—á–Ω–æ —Ä–∞–≤–µ–Ω **routing key** —Å–æ–æ–±—â–µ–Ω–∏—è. –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏.

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

* –ü—Ä—è–º–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è –ø–æ –∏–º–µ–Ω–∏/—Ç–∏–ø—É –∑–∞–¥–∞—á–∏.
* RPC/–æ—Ç–≤–µ—Ç—ã (reply_to –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `direct`).
* –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —á—ë—Ç–∫–æ –¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—á–µ—Ä–µ–¥—å/–≥—Ä—É–ø–ø—É.

## –ü—Ä–∏–º–µ—Ä (publisher + consumer)

```python
# publisher_direct.py
import pika

conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
ch = conn.channel()

ch.exchange_declare(exchange='logs_direct', exchange_type='direct', durable=True)

# example routing keys: 'info', 'warning', 'error'
routing_key = 'error'
message = 'Something went wrong'

ch.basic_publish(exchange='logs_direct',
                 routing_key=routing_key,
                 body=message,
                 properties=pika.BasicProperties(delivery_mode=2))  # persistent
print("Sent:", message)
conn.close()
```

```python
# consumer_direct.py
import pika

conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
ch = conn.channel()

ch.exchange_declare(exchange='logs_direct', exchange_type='direct', durable=True)
q = ch.queue_declare('', exclusive=True).method.queue  # –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

binding_key = 'error'
ch.queue_bind(exchange='logs_direct', queue=q, routing_key=binding_key)

def callback(ch, method, properties, body):
    print("Received:", body.decode())
    ch.basic_ack(method.delivery_tag)

ch.basic_consume(queue=q, on_message_callback=callback)
print("Waiting for messages...")
ch.start_consuming()
```

---

# 2) fanout

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

`fanout` ‚Äî —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω—ã–π: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç routing key –∏ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ **–≤—Å–µ** –æ—á–µ—Ä–µ–¥–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —ç—Ç–æ–º—É exchange. –≠—Ç–æ –∫–∞–∫ ¬´–≤–µ—â–∞–Ω–∏–µ¬ª.

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

* –†–∞—Å—Å—ã–ª–∫–∏/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º (broadcast).
* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–π, live-–æ–ø–æ–≤–µ—â–µ–Ω–∏—è, —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è —Å–æ–±—ã—Ç–∏–π.
* –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö—Ä–∞–Ω–∏–ª–∏—â –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

## –ü—Ä–∏–º–µ—Ä

```python
# publisher_fanout.py
import pika
conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
ch = conn.channel()
ch.exchange_declare(exchange='broadcast', exchange_type='fanout', durable=False)

ch.basic_publish(exchange='broadcast', routing_key='', body='Hello everyone!')
conn.close()
```

```python
# consumer_fanout.py
import pika
conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
ch = conn.channel()
ch.exchange_declare(exchange='broadcast', exchange_type='fanout')

q = ch.queue_declare('', exclusive=True).method.queue
ch.queue_bind(exchange='broadcast', queue=q)

def cb(ch, method, props, body):
    print("Got:", body.decode())
    ch.basic_ack(method.delivery_tag)

ch.basic_consume(queue=q, on_message_callback=cb)
ch.start_consuming()
```

---

# 3) topic

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

`topic` ‚Äî –≥–∏–±–∫–∏–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä –ø–æ —à–∞–±–ª–æ–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ **routing key**, –≥–¥–µ routing key ‚Äî —Ç–æ—á–∫–∞-—Ä–∞–∑–¥–µ–ª—ë–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `user.signup.eu`, `order.created.us`). –ü—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à–∞–±–ª–æ–Ω —Å –¥–≤—É–º—è —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏:

* `*` ‚Äî –∑–∞–º–µ–Ω—è–µ—Ç **—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω** —Å–µ–≥–º–µ–Ω—Ç (—Å–ª–æ–≤–æ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏).
* `#` ‚Äî –∑–∞–º–µ–Ω—è–µ—Ç **0 –∏–ª–∏ –±–æ–ª–µ–µ** —Å–µ–≥–º–µ–Ω—Ç–æ–≤.

–ù–∞–ø—Ä–∏–º–µ—Ä:

* binding key `log.*` –±—É–¥–µ—Ç –º–∞—Ç—á–∏—Ç—å `log.info` –Ω–æ –Ω–µ `log.info.db`.
* binding key `log.#` –º–∞—Ç—á–∏—Ç `log.info`, `log.info.db`, `log.error.db.svc` –∏ —Ç.–¥.
* binding key `user.*.eu` –º–∞—Ç—á–∏—Ç `user.signup.eu` –Ω–æ –Ω–µ `user.signup.us.eu` (–ø–æ—Ç–æ–º—É —á—Ç–æ `*` ‚Äî —Ä–æ–≤–Ω–æ 1 —Å–µ–≥–º–µ–Ω—Ç).

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

* –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Ç–µ–º–µ, –¥–æ–º–µ–Ω—É –∏–ª–∏ –≥–µ–æ/–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
* –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã, –≥–¥–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ —à–∞–±–ª–æ–Ω—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å–µ `order.*.eu` —Å–æ–±—ã—Ç–∏—è).
* –°–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –≥–¥–µ –Ω—É–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –º–Ω–æ–≥–æ–∫—Ä–∏—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–º—É routing key.

## –ü—Ä–∏–º–µ—Ä

```python
# publisher_topic.py
import pika
conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
ch = conn.channel()
ch.exchange_declare(exchange='topic_logs', exchange_type='topic')

# routing_key could be: 'kern.critical', 'auth.info', 'order.created.eu'
routing_key = 'order.created.eu'
ch.basic_publish(exchange='topic_logs', routing_key=routing_key, body='Order created in EU')
conn.close()
```

```python
# consumer_topic.py
import pika
conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
ch = conn.channel()
ch.exchange_declare(exchange='topic_logs', exchange_type='topic')

q = ch.queue_declare('', exclusive=True).method.queue
# example binding keys:
ch.queue_bind(exchange='topic_logs', queue=q, routing_key='order.*.eu')  # one use
ch.queue_bind(exchange='topic_logs', queue=q, routing_key='order.#')       # –ª—é–±–æ–µ –ø–æ order

def cb(ch, method, props, body):
    print("Got:", method.routing_key, body.decode())
    ch.basic_ack(method.delivery_tag)

ch.basic_consume(queue=q, on_message_callback=cb)
ch.start_consuming()
```

---

# 4) headers

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

`headers` exchange –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ **HTTP-style –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤** (message headers), –∞ –Ω–µ routing key. –ü—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –æ—á–µ—Ä–µ–¥–∏ –∫ exchange –≤—ã —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ –Ω–∞–±–æ—Ä –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ (binding arguments). –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –µ—Å–ª–∏ –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞ (headers) —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —É—Å–ª–æ–≤–∏—è–º. –í–∞–∂–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: `x-match`:

* `x-match: "all"` ‚Äî –≤—Å–µ –ø–∞—Ä—ã header –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å.
* `x-match: "any"` ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –ø–∞—Ä—ã.

headers matching –Ω–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –ø–æ—Ä—è–¥–∫—É –∏ —É–¥–æ–±–µ–Ω, –µ—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±–∞–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤.

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

* –ö–æ–≥–¥–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–ª–æ–∂–Ω–µ–µ, —á–µ–º –æ–¥–∏–Ω routing key –∏ —à–∞–±–ª–æ–Ω, –∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –≥–∏–±–∫–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `country=ru` –∏ `priority=high`).
* –ö–æ–≥–¥–∞ —É–¥–æ–±–Ω–µ–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö (–æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ dot-key).
* –°–ª–æ–∂–Ω—ã–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ/–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–Ω–æ–≥–æ–º–µ—Ä–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä.

## –ü—Ä–∏–º–µ—Ä

```python
# publisher_headers.py
import pika
conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
ch = conn.channel()
ch.exchange_declare(exchange='headers_logs', exchange_type='headers')

headers = {'format': 'pdf', 'department': 'sales'}
ch.basic_publish(
    exchange='headers_logs',
    routing_key='',  # ignored
    body='Report for sales',
    properties=pika.BasicProperties(headers=headers)
)
conn.close()
```

```python
# consumer_headers.py
import pika
conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
ch = conn.channel()
ch.exchange_declare(exchange='headers_logs', exchange_type='headers')

q = ch.queue_declare('', exclusive=True).method.queue

# bind with x-match = all
ch.queue_bind(exchange='headers_logs', queue=q, arguments={
    'x-match': 'all',
    'format': 'pdf',
    'department': 'sales'
})

def cb(ch, method, props, body):
    print("Got headers:", props.headers, "body:", body.decode())
    ch.basic_ack(method.delivery_tag)

ch.basic_consume(queue=q, on_message_callback=cb)
ch.start_consuming()
```

---

# –û–±—â–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

* **Durable / persistent**: –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±—Ä–æ–∫–µ—Ä–∞ ‚Äî exchange & queue –æ–±—ä—è–≤–∏—Ç—å `durable=True`, –∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ—Å—Ç–∞–≤–∏—Ç—å `delivery_mode=2` (persistent). –≠—Ç–æ –Ω–µ 100% –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É ‚Äî –Ω—É–∂–Ω—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, durable queues + persistent messages + –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.
* **Ack & QoS**: –≤—Å–µ–≥–¥–∞ `basic_ack` –≤ consumer; –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `basic_qos(prefetch_count=N)` —á—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –∫–æ–Ω—Å—å—é–º–µ—Ä.
* **Dead Letter Exchanges (DLX)**: –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ DLX/TTL/—Ä–µ-–ø—É–±–ª–∏–∫–∞—Ü–∏—é.
* **Binding –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π**: –æ–¥–∏–Ω exchange –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –æ—á–µ—Ä–µ–¥–µ–π —Å —Ä–∞–∑–Ω—ã–º–∏ binding keys ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è –º—É–ª—å—Ç–∏-–ø–æ–¥–ø–∏—Å–æ–∫.
* **–ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ç–∏–ø–æ–≤**: —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ exchange: `fanout` –¥–ª—è broadcast, `direct`/`topic` –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º; –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤—ã–≤–∞—Ç—å –∏–∑ –æ–¥–Ω–æ–≥–æ exchange –≤ –¥—Ä—É–≥–æ–π.
* **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: `direct` –∏ `fanout` —Å–∞–º—ã–µ –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ—Å—Ç–æ—Ç–æ–π –ª–æ–≥–∏–∫–∏. `topic` —á—É—Ç—å –¥–æ—Ä–æ–∂–µ (–ø–∞—Ç—Ç–µ—Ä–Ω-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ), `headers` ‚Äî —Å–∞–º—ã–π –≥–∏–±–∫–∏–π, –Ω–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Å–ª–æ–∂–Ω–µ–µ –∏ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ binding –ø—Ä–∞–≤–∏–ª.
* **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å/–∏–∑–æ–ª—è—Ü–∏—è**: –¥–ª—è –æ–≥—Ä–æ–º–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ exchange/queue –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º/–≤–æ—Ä–∫–µ—Ä–∞–º; –∏–∑–±–µ–≥–∞–π—Ç–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—á–µ—Ä–µ–¥–µ–π –≤ –æ–¥–Ω–æ–º exchange –±–µ–∑ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏.

---

# –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Å–ª—É—á–∞–µ (–∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

* –ù—É–∂–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É ‚Üí **direct**.
* –ù—É–∂–Ω–æ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º (–≤—Å–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ) ‚Üí **fanout**.
* –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Ç–µ–º–µ / –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —É—Ä–æ–≤–Ω—è–º (–∫–∞—Ç–µ–≥–æ—Ä–∏—è.–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è.—Ä–µ–≥–∏–æ–Ω) ‚Üí **topic**.
* –ú–Ω–æ–≥–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤/—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–∞–±–æ—Ä–∞–º —Å–≤–æ–π—Å—Ç–≤ ‚Üí **headers**.

---

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

* –õ–æ–≥–∏: `fanout` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–ø–∏–π –ª–æ–≥–æ–≤ –≤ —Ä–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (—Ñ–∞–π–ª, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥).
* –°–æ–±—ã—Ç–∏—è –¥–æ–º–µ–Ω–∞: `topic` –¥–ª—è `order.created.eu` / `order.created.us` / `order.refunded.#`.
* –û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É/–∫–æ–º–∞–Ω–¥–µ: `direct` ‚Äî `task.email`, `task.pdf`, `task.cleanup`.
* –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º (content-type, region, VIP): `headers` —Å `x-match=all`.

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É:

* –ü—Ä–∏—Å–ª–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º–∏ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–µ–π `topic` –∏ `headers` –≤ –æ–¥–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ.
* –ü–æ–∫–∞–∑–∞—Ç—å, –∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ RabbitMQ –≤ Docker –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å persistence, DLX –∏ –ø–æ–ª–∏—Ç–∏–∫–∏.
* –ò–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–æ–º (`aio-pika` / `asyncio`) –¥–ª—è –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫.

–ö–∞–∫–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—à—å?



